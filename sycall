#!/usr/bin/env python3
import argparse
import os
import time
import subprocess
from pathlib import Path
import sys
import termios
import tty
import signal
import grp

def ensure_wheel_member():
    try:
        wheel_gid = grp.getgrnam("wheel").gr_gid
    except KeyError:
        print("[syscall] ERROR: group 'wheel' does not exist!")
        exit(1)

    user_groups = os.getgroups()
    user_gid = os.getgid()

    if wheel_gid not in user_groups and wheel_gid != user_gid:
        print("[syscall] Permission denied: user is not in wheel group")
        exit(1)


def masked_input(prompt="[syscall] password: "):
    sys.stdout.write(prompt)
    sys.stdout.flush()
    password = ""
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)

    try:
        tty.setcbreak(fd)
        while True:
            ch = sys.stdin.read(1)
            if ch in ("\n", "\r"):
                break
            if ch == "\x03":
                print()
                raise KeyboardInterrupt
            if ch == "\x7f":
                if password:
                    password = password[:-1]
                    sys.stdout.write("\b \b")
                    sys.stdout.flush()
            else:
                password += ch
                sys.stdout.write("*")
                sys.stdout.flush()
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)

    print()
    return password

RUNTIME_DIR = Path(os.environ.get("XDG_RUNTIME_DIR", f"/run/user/{os.getuid()}"))
CACHE_DIR = RUNTIME_DIR / "syscall"
CACHE_FILE = CACHE_DIR / "timestamp"
CONFIG_FILE = CACHE_DIR / "config"

HELPER = "/usr/lib/syscall-helper"
DEFAULT_MINUTES = 3

def load_config():
    if CONFIG_FILE.exists():
        try:
            return int(CONFIG_FILE.read_text().strip())
        except:
            pass
    return DEFAULT_MINUTES

def save_config(minutes):
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    CONFIG_FILE.write_text(str(minutes))

def save_timestamp():
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    CACHE_FILE.write_text(str(time.time()))

def load_timestamp():
    try:
        return float(CACHE_FILE.read_text().strip())
    except:
        return None

def clear_cache():
    if CACHE_FILE.exists():
        CACHE_FILE.unlink()

def cache_valid():
    ts = load_timestamp()
    if ts is None:
        return False
    lifetime = load_config() * 60
    return (time.time() - ts) < lifetime

def seconds_left():
    ts = load_timestamp()
    if ts is None:
        return 0
    lifetime = load_config() * 60
    return max(0, int(lifetime - (time.time() - ts)))

def pam_authenticate():

    import pam
    pw = masked_input("[syscall] password: ")
    auth = pam.pam()

    return auth.authenticate(os.getlogin(), pw, service="syscall")

def run_command(cmd):
    if cache_valid():
        return subprocess.run([HELPER] + cmd).returncode


    if pam_authenticate():
        return subprocess.run([HELPER] + cmd).returncode

    print("Authentication failed.")
    return 1

def enable_cache(minutes):
    save_config(minutes)

    if pam_authenticate():
        save_timestamp()
        print(f"Cache enabled for {minutes} minutes.")
    else:
        print("Authentication failed. Cache not enabled.")

def main():
    ensure_wheel_member()

    parser = argparse.ArgumentParser(description="syscall â€” minimal sudo-like privilege elevation tool for Linux.")
    parser.add_argument("--enable", type=int, help="Enable passwordless mode for N minutes")
    parser.add_argument("--disable", action="store_true", help="Disable passwordless mode")
    parser.add_argument("--status", action="store_true", help="Show current passwordless status")
    parser.add_argument("cmd", nargs=argparse.REMAINDER, help="Command to run")

    args = parser.parse_args()

    try:
        if args.enable is not None:
            enable_cache(args.enable)
            return

        if args.disable:
            clear_cache()
            print("Passwordless mode disabled.")
            return

        if args.status:
            if cache_valid():
                left = seconds_left()
                print(f"Passwordless mode active ({left}s remaining).")
            else:
                print("Passwordless mode is NOT active.")
            return

        if not args.cmd:
            print("Usage: sycall <command>")
            return

        exit(run_command(args.cmd))

    except KeyboardInterrupt:
        print("\nCancelled by user.")
        exit(1)

if __name__ == "__main__":
    main()
